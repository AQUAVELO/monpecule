<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conseil du jour - MonPecule</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        h1 { font-size: 2rem; color: #2C3E50; display: flex; align-items: center; gap: 10px; }
        .subtitle { color: #7F8C8D; margin-top: 5px; font-size: 0.9rem; }
        
        .btn-back {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: 0.2s;
            display: inline-block;
        }
        .btn-back:hover { background: #5a6268; opacity: 0.9; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .stat-value { font-size: 2rem; font-weight: 700; color: #2C3E50; }
        .stat-label { color: #7F8C8D; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        
        /* Tickers Grid */
        .section-title { font-size: 1.5rem; margin: 40px 0 20px; color: #2C3E50; display: flex; align-items: center; gap: 10px; }
        
        .tickers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .ticker-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .ticker-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            border-color: #667eea;
        }
        
        .top-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #FFD700;
            color: #333;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 5px 10px;
            border-bottom-left-radius: 10px;
        }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .ticker-name { font-size: 1.2rem; font-weight: 700; color: #2C3E50; }
        .ticker-symbol { font-size: 0.8rem; color: #95a5a6; font-weight: 600; }
        .ticker-price { font-size: 1.3rem; font-weight: 700; color: #2C3E50; }
        
        .sentiment-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin: 15px 0 10px;
            overflow: hidden;
        }
        
        .sentiment-fill { height: 100%; border-radius: 3px; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #7f8c8d; }
        
        .signal-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .signal-achat { background: #d4edda; color: #155724; }
        .signal-vente { background: #f8d7da; color: #721c24; }
        .signal-neutre { background: #fff3cd; color: #856404; }
        
        .click-hint { font-size: 0.75rem; color: #667eea; margin-top: 10px; text-align: center; opacity: 0; transition: 0.2s; }
        .ticker-card:hover .click-hint { opacity: 1; }

        /* Empty State */
        .empty-state {
            text-align: center; 
            padding: 60px 20px; 
            background: white; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>üí° Conseil du Jour</h1>
            <p class="subtitle">Analyse de sentiment IA sur le SBF 120 + Portefeuille ‚Ä¢ {{ date_maj }}</p>
        </div>
        <div>
            <button onclick="refreshAnalysis()" class="btn-back" style="background: #28a745; margin-right: 10px; cursor: pointer; border: none;">‚Üª Mettre √† jour l'analyse (SBF 120)</button>
            <a href="/dashboard" class="btn-back">‚Üê Retour</a>
        </div>
    </div>

    <!-- Status de mise √† jour -->
    <div id="updateStatus" style="display: none; background: #e8f5e9; color: #1b5e20; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #c8e6c9;">
        <!-- Sera rempli par JS -->
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">{{ achats }}</div>
            <div class="stat-label">Signaux Achat</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ffc107;">{{ neutres }}</div>
            <div class="stat-label">Neutres</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #dc3545;">{{ ventes }}</div>
            <div class="stat-label">Signaux Vente</div>
        </div>
    </div>

    {% if not results %}
    <div class="empty-state">
        <div style="font-size: 4rem; margin-bottom: 20px;">ü§ñ</div>
        <h2 style="color: #2C3E50; margin-bottom: 10px;">Aucune analyse disponible</h2>
        <p style="color: #7F8C8D; font-size: 1.1rem; margin-bottom: 30px;">C'est votre premi√®re visite ou la base de donn√©es est vide.</p>
        <button onclick="refreshAnalysis()" class="btn-back" style="background: #28a745; cursor: pointer; border: none; font-size: 1.1rem; padding: 15px 30px;">
            üöÄ Lancer l'analyse compl√®te (SBF 120)
        </button>
        <p style="color: #95a5a6; font-size: 0.9rem; margin-top: 15px;">Cela prendra environ 2 √† 3 minutes en arri√®re-plan.</p>
    </div>
    {% else %}

    <h2 class="section-title">üèÜ TOP 7 - Meilleurs Sentiments</h2>
    <div class="tickers-grid">
        {% for r in results[:7] %}
        <div class="ticker-card" onclick="openYahoo('{{ r.ticker }}')">
            <div class="top-badge">#{{ loop.index }}</div>
            <div class="card-header">
                <div>
                    <div class="ticker-name">{{ r.name }}</div>
                    <div class="ticker-symbol">{{ r.ticker }}</div>
                </div>
                {% if r.price %}
                <div class="ticker-price">{{ "%.2f"|format(r.price) }}‚Ç¨</div>
                {% endif %}
            </div>
            
            <div class="sentiment-bar">
                <div class="sentiment-fill" style="width: {{ r.score * 100 }}%; background: {% if r.score >= 0.5 %}#28a745{% elif r.score < 0 %}#dc3545{% else %}#ffc107{% endif %};"></div>
            </div>
            
            <div class="card-footer">
                <span>Score: <strong>{{ "%.2f"|format(r.score) }}</strong></span>
                <span class="signal-badge {{ r.signal_class }}">{{ r.signal }}</span>
            </div>
            <div class="click-hint">üìä Voir l'historique sur Yahoo Finance</div>
        </div>
        {% endfor %}
    </div>

    <h2 class="section-title">üìã Autres valeurs</h2>
    <div class="tickers-grid">
        {% for r in results[7:] %}
        <div class="ticker-card" onclick="openYahoo('{{ r.ticker }}')">
            <div class="card-header">
                <div>
                    <div class="ticker-name">{{ r.name }}</div>
                    <div class="ticker-symbol">{{ r.ticker }}</div>
                </div>
                {% if r.price %}
                <div class="ticker-price">{{ "%.2f"|format(r.price) }}‚Ç¨</div>
                {% endif %}
            </div>
            <div class="card-footer">
                <span>Score: {{ "%.2f"|format(r.score) }}</span>
                <span class="signal-badge {{ r.signal_class }}">{{ r.signal }}</span>
            </div>
            <div class="click-hint">üìä Voir l'historique sur Yahoo Finance</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    // V√©rifier le statut toutes les 5 secondes
    let checkInterval;
    
    function startPolling() {
        checkInterval = setInterval(() => {
            fetch('/api/check_analysis_status')
                .then(r => r.json())
                .then(data => {
                    // Si on a des donn√©es (> 0), on recharge la page
                    if (data.count > 0) {
                        console.log("Donn√©es trouv√©es ! Rechargement...");
                        clearInterval(checkInterval);
                        window.location.reload();
                    }
                })
                .catch(err => console.error("Polling error", err));
        }, 5000); // 5 secondes
    }

    function refreshAnalysis() {
        if (!confirm("Lancer l'analyse compl√®te sur ~250 titres ? Cela prendra environ 2 minutes en arri√®re-plan.")) return;
        
        const statusDiv = document.getElementById('updateStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<h3>‚è≥ Analyse en cours...</h3><p>Le serveur analyse environ 250 actions (SBF 120 + CAC Mid/Small).</p><p>Cela prend g√©n√©ralement <b>2 √† 3 minutes</b>.</p><p>La page se rafra√Æchira automatiquement une fois termin√©.</p>';
        
        fetch('/api/update_market_analysis')
            .then(r => r.json())
            .then(data => {
                console.log(data.message);
                // D√©marrer le polling
                startPolling();
            })
            .catch(err => {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = 'Erreur lors du lancement de l\'analyse.';
            });
    }
    
    function openYahoo(ticker) {
        // Yahoo Finance utilise souvent le format .PA pour Paris
        const url = 'https://fr.finance.yahoo.com/quote/' + ticker;
        window.open(url, '_blank');
    }

    // Si on est sur une page vide, on lance le polling au cas o√π une analyse serait d√©j√† en cours
    {% if not results %}
        startPolling();
    {% endif %}
</script>

</body>
</html>